# 从程序的角度看，内存是什么？

## 内存的基本概念

我们可以把内存理解为一个数组，其中每个元素可以保存 1 字节（byte）的数据。

在数组中访问一个元素可以使用索引，同样为了能访问内存中的元素，每个元素都有自己的地址。

从上面的描述中，我们可以看出：
1. 内存的最小空间是1个字节（byte）。
2. 内存是由许多这样的空间组合在一起的。
3. 每个空间都有一个地址。

我们以一个 4 位寻址空间的内存为例，用图形模拟一下内存的形象（只是模拟，真实的内存不是这样的）。

所谓 4 位 寻址空间，是指内存地址的范围是用 4 位（bit）的二进制表示，从 0000 到 1111，换算成十进制就是 0 - 15。每个地址可以保存 1 个字节（byte）的数据，因此这个内存的容量就是 16 个字节。

1111
1110
1101
1100
1011
1010
1001
1000
0111
0110
0101
0100
0011
0010
0001
0000

Q: 为什么内存最小空间是 1 个字节（byte）？ 

## 64位操作系统内存空间

现在的操作系统都是 64 位，意思就是可以使用的内存地址范围是：

0000000000000000000000000000000000000000000000000000000000000000（64个0）

~

1111111111111111111111111111111111111111111111111111111111111111（64个1）

二进制的显示太长，换算成十六进制：

0x0000000000000000 ~ 0xFFFFFFFFFFFFFFFF

这么大的内存寻址空间，最多可以存储多少数据？

2的64次方 = 18,446,744,073,709,551,616 字节（byte），大概是16,777,216 TB。

这个数字跟我们的实际经验是不一致的，我们的个人电脑，内存大概就是 8/16/32 GB，现实生活中也不可能有这么大的内存。

那么我们为什么还要讨论这个看上去不太现实的寻址空间呢？这时候我们就需要切换一下视角，从程序的角度来看看内存是什么样子的？

Q:32位操作系统的内存寻址空间是多少？

## 程序角度的内存

我们可以想象一下，一台有 32 G 内存的计算机，正在运行着浏览器，Word 等程序。这时候内存的使用情况大概是什么样子呢？

打开 Windows 电脑的任务管理器我们就能看到，每个程序都占用着一定数量的内存。

看到这我们可能会认为，这些程序直接操作着内存中的某个区域。

然而真实情况是，程序本事是无法直接操作物理内存，程序所能操作的是**虚拟内存**。

这个虚拟内存有这么几个特点：

1. 每个程序都感觉自己单独拥有系统的整个内存。

2. 每个程序可以看到的内存地址范围是 0x0000000000000000 ~ 0xFFFFFFFFFFFFFFFF，而不是计算机真实的内存寻址空间。

3. 每个程序实际可以使用的内存寻址空间是 0x0000000000000000 ~ 0x00007FFFFFFFFFFF 。0x0000800000000000 ~ 0xFFFFFFFFFFFFFFFF 这个寻址空间的内存属于操作系统内核虚拟内存。

也就是说每个程序都感觉自己拥有了完整的64位寻址空间的内存。

看到这里我们肯定会好奇：

    * 虚拟内存是什么技术？
    * 虚拟内存如何映射到物理内存？
    * 虚拟内存这么大，如果程序使用范围了超出物理内存的空间，会发生什么情况？
    ...

这些问题都需要理解虚拟内存这项技术之后才能解答。

现阶段我们只需知道，每个程序看到的内存都是操作系统所能提供的完整寻址空间的内存，并且有一个叫虚拟内存的技术，可以将程序在这里使用的内存映射到物理内存上。

## 程序视角内存的布局

作为一个程序员，我首先整理一下自己知道的内存相关的常识：
1. 写出来的代码文件，最终会编译成可执行文件。
2. 听说过堆（Heap）和栈（Stack），但是不太清楚。

从程序的视角来看，了解内存的布局可以对上面的常识有一个比较深入的理解。

下面这段代码是从 CMU 15-213 CSAPP 课件中找到的，可以帮助我们理解内存的布局。

12081:   ./malloc
     Address Perm   Offset Device Inode    Size  Rss Pss Referenced Anonymous LazyFree ShmemPmdMapped FilePmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked THPeligible Mapping
55c0e5737000 r--p 00000000  08:20 78312       4    4   4          4         0        0              0             0              0               0    0       0      0           0 malloc
55c0e5738000 r-xp 00001000  08:20 78312       4    4   4          4         0        0              0             0              0               0    0       0      0           0 malloc
55c0e5739000 r--p 00002000  08:20 78312       4    4   4          4         0        0              0             0              0               0    0       0      0           0 malloc
55c0e573a000 r--p 00002000  08:20 78312       4    4   4          4         4        0              0             0              0               0    0       0      0           0 malloc
55c0e573b000 rw-p 00003000  08:20 78312       4    4   4          4         4        0              0             0              0               0    0       0      0           0 malloc
55c0e573c000 rw-p 00000000  00:00     0 2113536    0   0          0         0        0              0             0              0               0    0       0      0           1
55c168662000 rw-p 00000000  00:00     0     132    4   4          4         4        0              0             0              0               0    0       0      0           0 [heap]
7f63a8d9a000 rw-p 00000000  00:00     0 4456456    8   8          8         8        0              0             0              0               0    0       0      0           1
7f64b8d9c000 r--p 00000000  08:20 40180     148  144   5        144         0        0              0             0              0               0    0       0      0           0 libc-2.31.so
7f64b8dc1000 r-xp 00025000  08:20 40180    1504  944  40        944         0        0              0             0              0               0    0       0      0           0 libc-2.31.so
7f64b8f39000 r--p 0019d000  08:20 40180     296  124   4        124         0        0              0             0              0               0    0       0      0           0 libc-2.31.so
7f64b8f83000 ---p 001e7000  08:20 40180       4    0   0          0         0        0              0             0              0               0    0       0      0           0 libc-2.31.so
7f64b8f84000 r--p 001e7000  08:20 40180      12   12  12         12        12        0              0             0              0               0    0       0      0           0 libc-2.31.so
7f64b8f87000 rw-p 001ea000  08:20 40180      12   12  12         12        12        0              0             0              0               0    0       0      0           0 libc-2.31.so
7f64b8f8a000 rw-p 00000000  00:00     0      24   24  24         24        24        0              0             0              0               0    0       0      0           0
7f64b8f9e000 r--p 00000000  08:20 40176       4    4   0          4         0        0              0             0              0               0    0       0      0           0 ld-2.31.so
7f64b8f9f000 r-xp 00001000  08:20 40176     140  140   5        140         0        0              0             0              0               0    0       0      0           0 ld-2.31.so
7f64b8fc2000 r--p 00024000  08:20 40176      32   32   1         32         0        0              0             0              0               0    0       0      0           0 ld-2.31.so
7f64b8fcb000 r--p 0002c000  08:20 40176       4    4   4          4         4        0              0             0              0               0    0       0      0           0 ld-2.31.so
7f64b8fcc000 rw-p 0002d000  08:20 40176       4    4   4          4         4        0              0             0              0               0    0       0      0           0 ld-2.31.so
7f64b8fcd000 rw-p 00000000  00:00     0       4    4   4          4         4        0              0             0              0               0    0       0      0           0
7ffc1bc0f000 rw-p 00000000  00:00     0     132   12  12         12        12        0              0             0              0               0    0       0      0           0 [stack]
7ffc1bcb5000 r--p 00000000  00:00     0      16    0   0          0         0        0              0             0              0               0    0       0      0           0 [vvar]
7ffc1bcb9000 r-xp 00000000  00:00     0       4    4   0          4         0        0              0             0              0               0    0       0      0           0 [vdso]
                                        ======= ==== === ========== ========= ======== ============== ============= ============== =============== ==== ======= ====== ===========
                                        6572484 1496 159       1496        92        0              0             0              0               0    0       0      0           2 KB

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

char big_array1[1L << 24];  /*16M*/
char huge_array[1L << 31];  /*2G*/

int global = 0;

int useless() { return 0; }

int main()
{
    void *p1, *p2, *p3, *p4;
    int local = 0;
    p1 = malloc(1L << 28);  /*256M*/
    p2 = malloc(1L << 8);   /*256B*/
    p3 = malloc(1L << 32);  /*4G*/
    p4 = malloc(1L << 8);   /*256B*/

    //print points statement
}
```

我们先来解释一下这段代码：
1. `1L` 是一个值为 1 的 long 类型数值；
2. `1L << 24` 是将 1 左移 24，得到的值等于 2 的 24 次方，16777216。
3. `char` 类型的值是 1 个字节，所以 `char big_array1[1L << 24];` 这个数组需要16777216 个字节，也就是 16 M。
4. `big_array1`，`huge_array` 和 `global` 为全局变量。
5. `useless` 是一个函数。
6. `main` 中的 `local` 是局部变量。
7. `malloc` 函数的作用是在内存中手动分配空间，参数为分配空间的字节数。
8. `p1` 定义为指针，指向 malloc 分配内存空间的首地址。 

当我们想办法输出各个对象的内存地址时，我们可以看到他们在内存中的位置。

|section|name|memory address|address dec|
|:--|:--|:--|:--|
|stack |local     |0x00007fff3656bed4  |140734105042644|
|heap |p1         |0x00007f48fa5b8010  |139951414673424|
|heap |p3         |0x00007f47fa5b7010  |139947119702032|
|heap |p2         |0x000055fcb18d02a0  |94543798928032|
|heap |p4         |0x000055fcb18d03b0  |94543798928304|
|data |huge_array |0x000055fc30469040  |94541630050368|
|data |big_array  |0x000055fc2f469040  |94541613273152|
|data |global     |0x000055fc2f469024  |94541613273124|
|text |code useless       |0x000055fc2f466189  |94541613261193|
|text |code main  |0x000055fc2f4661bb  |94541613261243|

表格中第一列是根据内存所在区域的功能起的名字：stack，heap，data，text
第二列是代码中的变量和函数
第三列是变量和函数对应的内存的起始地址（即指针）
第四列是内存地址对应的十进制表示

从中我们可以看到不同内存的布局，不同的区域都分布在内存的哪个位置。

stack
heap
...
heap
data
text

为了更加精确的知道每个区域的详细位置，我们使用了命令 pmap 来查看内存的详细信息

```cmd
pmap -X `pidof malloc`
```
stack local     0x7ffc1bc2e8e4  140720774244580
heap p1         0x7f64a8d9b010  140070306295824
heap p3         0x7f63a8d9a010  140066011324432
heap p2         0x55c1686622a0  94289168573088
heap p4         0x55c1686623b0  94289168573360
data huge_array 0x55c0e673b040  94286988423232
data big_array  0x55c0e573b040  94286971646016
data global     0x55c0e573b024  94286971645988
text code useless       0x55c0e57381a9  94286971634089
text code main  0x55c0e57381db  94286971634139



附录：

输出地址的完整版本：

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

static void show_pointer(void *p, char *descr)
{
    printf("%s\t%p\t%lu\n", descr, p, (unsigned long)p);
}

char big_array1[1L << 24]; /*16M*/
char huge_array[1L << 31]; /*2G*/

int global = 0;

int useless() { return 0; }

int main()
{
    void *p1, *p2, *p3, *p4;
    int local = 0;
    p1 = malloc(1L << 28); /*256M*/
    p2 = malloc(1L << 8);  /*256B*/
    p3 = malloc(1L << 32); /*4G*/
    p4 = malloc(1L << 8);

    show_pointer((void *)&local, "stack local");
    show_pointer((void *)p1, "heap p1\t");
    show_pointer((void *)p3, "heap p3\t");
    show_pointer((void *)p2, "heap p2\t");
    show_pointer((void *)p4, "heap p4\t");
    show_pointer((void *)huge_array, "data huge_array");
    show_pointer((void *)big_array1, "data big_array");
    show_pointer((void *)&global, "data global");
    show_pointer((void *)useless, "text code useless");
    show_pointer((void *)main, "text code main");
    //pause();
}
```